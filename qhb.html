<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ¢çº¢åŒ… - æ¯äººé™é¢†ä¸€ä¸ª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            width: 100%;
            text-align: center;
        }
        
        .header {
            margin-bottom: 30px;
        }
        
        .title {
            color: #e4393c;
            font-size: 32px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .rules {
            background: rgba(255,255,255,0.8);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .rules p {
            margin: 5px 0;
            color: #555;
            font-size: 14px;
        }
        
        .hongbao {
            width: 180px;
            height: 240px;
            background: linear-gradient(145deg, #ff4d4d, #cc0000);
            border: 5px solid #ffd700;
            border-radius: 15px;
            margin: 0 auto 30px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .hongbao:hover:not(.opened) {
            transform: translateY(-10px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        }
        
        .hongbao:active:not(.opened) {
            transform: scale(0.95);
        }
        
        .hongbao::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 20px;
            background: #ffd700;
            border-radius: 0 0 10px 10px;
        }
        
        .char {
            font-size: 80px;
            color: #ffd700;
            font-weight: bold;
            text-shadow: 3px 3px 0 #8b0000;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .hongbao.opened {
            background: linear-gradient(145deg, #ffcccc, #ff9999);
            cursor: default;
            animation: openEffect 0.5s ease;
        }
        
        .hongbao.opened .char {
            display: none;
        }
        
        .amount-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            width: 100%;
        }
        
        .amount {
            font-size: 36px;
            color: #e4393c;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .amount-text {
            font-size: 20px;
            color: #ffd700;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .yuan {
            font-size: 24px;
            color: #e4393c;
        }
        
        .result-info {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding-bottom: 10px;
            border-bottom: 1px dashed #eee;
        }
        
        .info-label {
            color: #666;
        }
        
        .info-value {
            color: #e4393c;
            font-weight: bold;
        }
        
        .device-info {
            font-size: 12px;
            color: #999;
            margin-top: 15px;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 5px;
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #e4393c, #ff6b6b);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(228, 57, 60, 0.3);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #666;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        @keyframes openEffect {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        
        .hidden {
            display: none;
        }
        
        .congrats {
            background: linear-gradient(135deg, #ffd700, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 28px;
            font-weight: bold;
            margin: 20px 0;
            padding: 10px;
        }
        
        .share-tip {
            font-size: 14px;
            color: #666;
            margin-top: 20px;
            padding: 10px;
            background: rgba(255,255,255,0.8);
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">ğŸ§§ æ­å–œå‘è´¢</h1>
            <p class="subtitle">ä»…é™4ä»½ï¼Œå¥½è¿è¿è¿</p>
        </div>
        
        <div class="rules">
            <p>ğŸ¯ è§„åˆ™è¯´æ˜ï¼š</p>
            <p>â€¢ æ¯ä¸ªè®¾å¤‡é™é¢†ä¸€ä¸ªçº¢åŒ…</p>
            <p>â€¢ æ€»é‡‘é¢3å…ƒï¼Œ4ä¸ªçº¢åŒ…éšæœºåˆ†é…</p>
            <p>â€¢ ç‚¹å‡»ä¸‹æ–¹çº¢åŒ…å³å¯é¢†å–</p>
        </div>
        
        <!-- çº¢åŒ…åŒºåŸŸ -->
        <div class="hongbao" id="hongbao">
            <div class="char" id="char">æ‹†</div>
            <div class="amount-display hidden" id="amountDisplay">
                <div class="amount" id="amount">0.00</div>
                <div class="amount-text">å…ƒ <span class="yuan">ğŸ’°</span></div>
            </div>
        </div>
        
        <!-- ç»“æœä¿¡æ¯ -->
        <div class="result-info fade-in" id="resultInfo" style="display: none;">
            <div class="congrats" id="congratsText">æ­å–œå‘è´¢ï¼</div>
            <div class="info-item">
                <span class="info-label">æ‚¨çš„çº¢åŒ…é‡‘é¢ï¼š</span>
                <span class="info-value" id="yourAmount">0.00 å…ƒ</span>
            </div>
            <div class="info-item">
                <span class="info-label">çº¢åŒ…é¢†å–çŠ¶æ€ï¼š</span>
                <span class="info-value" id="statusText">ç­‰å¾…é¢†å–</span>
            </div>
            <div class="info-item">
                <span class="info-label">å‰©ä½™çº¢åŒ…æ•°é‡ï¼š</span>
                <span class="info-value" id="remainingCount">4 ä¸ª</span>
            </div>
            <div class="info-item">
                <span class="info-label">å‰©ä½™æ€»é‡‘é¢ï¼š</span>
                <span class="info-value" id="remainingAmount">3.00 å…ƒ</span>
            </div>
            
            <div class="device-info">
                <div>è®¾å¤‡IDï¼š<span id="deviceId"></span></div>
                <div>é¢†å–æ—¶é—´ï¼š<span id="receiveTime"></span></div>
            </div>
        </div>
        
        <div class="buttons">
            <button class="btn btn-primary" id="openBtn" onclick="openHongbao()">ç‚¹å‡»æ‹†çº¢åŒ…</button>
            <button class="btn btn-secondary" onclick="resetData()" id="resetBtn">æ¸…é™¤æ•°æ®é‡æ–°å¼€å§‹</button>
        </div>
        
        <div class="share-tip" id="shareTip">
            ğŸ”” æç¤ºï¼šé¢†å–åå‘æˆªå›¾åœ¨ç¾¤é‡Œï¼Œå¾®ä¿¡è½¬é’±ï¼Œä¸è¦æ¸…é™¤æ•°æ®
        </div>
    </div>

    <script>
        // ç”Ÿæˆè®¾å¤‡å”¯ä¸€æ ‡è¯†ç¬¦
        function generateDeviceId() {
            let deviceId = localStorage.getItem('redpacket_device_id');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('redpacket_device_id', deviceId);
            }
            return deviceId;
        }
        
        // ç”Ÿæˆç›¸å¯¹å¹³å‡çš„é‡‘é¢åˆ†é…
        function generateBalancedAmounts() {
            const total = 300; // 3å…ƒè½¬æ¢ä¸ºåˆ†
            const amounts = [];
            
            // åˆå§‹åˆ†é…ï¼šæ¯ä¸ªçº¢åŒ…75åˆ†ï¼ˆ0.75å…ƒï¼‰
            for (let i = 0; i < 4; i++) {
                amounts.push(75);
            }
            
            // éšæœºè°ƒæ•´é‡‘é¢ï¼Œç¡®ä¿æ€»é‡‘é¢ä¸å˜ä¸”ç›¸å¯¹å¹³å‡
            const adjustmentRounds = 10;
            for (let round = 0; round < adjustmentRounds; round++) {
                const fromIndex = Math.floor(Math.random() * 4);
                const toIndex = Math.floor(Math.random() * 4);
                if (fromIndex === toIndex) continue;
                
                // æ¯æ¬¡è°ƒæ•´çš„é‡‘é¢åœ¨10-30åˆ†ä¹‹é—´
                const adjustAmount = Math.floor(Math.random() * 20) + 10;
                
                // ç¡®ä¿è°ƒæ•´åé‡‘é¢åœ¨åˆç†èŒƒå›´å†…ï¼ˆ30-150åˆ†ï¼‰
                if (amounts[fromIndex] - adjustAmount >= 30 && 
                    amounts[toIndex] + adjustAmount <= 150) {
                    amounts[fromIndex] -= adjustAmount;
                    amounts[toIndex] += adjustAmount;
                }
            }
            
            // éªŒè¯æ€»é‡‘é¢
            const sum = amounts.reduce((a, b) => a + b, 0);
            if (sum !== total) {
                // å¾®è°ƒæœ€åä¸€ä¸ªçº¢åŒ…ç¡®ä¿æ€»é‡‘é¢æ­£ç¡®
                const diff = total - sum;
                amounts[3] += diff;
            }
            
            // è½¬æ¢ä¸ºå…ƒï¼ˆä¸¤ä½å°æ•°ï¼‰
            return amounts.map(amount => amount / 100);
        }
        
        // è·å–æˆ–åˆ†é…çº¢åŒ…
        function getOrAssignRedPacket(deviceId) {
            let assignedPackets = JSON.parse(localStorage.getItem('redpacket_assigned_packets') || '{}');
            let packetAmounts = JSON.parse(localStorage.getItem('redpacket_amounts'));
            
            // å¦‚æœæ²¡æœ‰é¢„åˆ†é…é‡‘é¢ï¼Œç”Ÿæˆæ–°çš„é‡‘é¢åˆ†é…
            if (!packetAmounts || packetAmounts.length !== 4) {
                packetAmounts = generateBalancedAmounts();
                localStorage.setItem('redpacket_amounts', JSON.stringify(packetAmounts));
            }
            
            // å¦‚æœè¯¥è®¾å¤‡å·²ç»åˆ†é…è¿‡çº¢åŒ…ï¼Œè¿”å›å·²åˆ†é…çš„çº¢åŒ…
            if (assignedPackets[deviceId]) {
                return {
                    index: assignedPackets[deviceId].index,
                    amount: assignedPackets[deviceId].amount,
                    isNew: false,
                    timestamp: assignedPackets[deviceId].timestamp
                };
            }
            
            // å¯»æ‰¾æœªåˆ†é…çš„çº¢åŒ…
            const assignedIndices = Object.values(assignedPackets).map(p => p.index);
            let availableIndices = [0, 1, 2, 3].filter(i => !assignedIndices.includes(i));
            
            if (availableIndices.length === 0) {
                return null; // æ‰€æœ‰çº¢åŒ…éƒ½å·²åˆ†é…
            }
            
            // éšæœºé€‰æ‹©ä¸€ä¸ªæœªåˆ†é…çš„çº¢åŒ…
            const randomIndex = Math.floor(Math.random() * availableIndices.length);
            const packetIndex = availableIndices[randomIndex];
            const amount = packetAmounts[packetIndex];
            
            // ä¿å­˜åˆ†é…è®°å½•
            assignedPackets[deviceId] = {
                index: packetIndex,
                amount: amount,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('redpacket_assigned_packets', JSON.stringify(assignedPackets));
            
            return {
                index: packetIndex,
                amount: amount,
                isNew: true,
                timestamp: assignedPackets[deviceId].timestamp
            };
        }
        
        // è·å–çº¢åŒ…ç»Ÿè®¡ä¿¡æ¯
        function getRedPacketStats() {
            const assignedPackets = JSON.parse(localStorage.getItem('redpacket_assigned_packets') || '{}');
            const packetAmounts = JSON.parse(localStorage.getItem('redpacket_amounts') || '[0.75,0.75,0.75,0.75]');
            
            const totalAssigned = Object.keys(assignedPackets).length;
            const totalAmountAssigned = Object.values(assignedPackets).reduce((sum, p) => sum + p.amount, 0);
            
            return {
                assignedCount: totalAssigned,
                remainingCount: 4 - totalAssigned,
                assignedAmount: totalAmountAssigned.toFixed(2),
                remainingAmount: (3 - totalAmountAssigned).toFixed(2),
                totalAmounts: packetAmounts
            };
        }
        
        // æ‰“å¼€çº¢åŒ…
        function openHongbao() {
            const deviceId = generateDeviceId();
            const packet = getOrAssignRedPacket(deviceId);
            
            if (!packet) {
                alert('æ‰€æœ‰çº¢åŒ…å·²è¢«æŠ¢å…‰ï¼');
                return;
            }
            
            const hongbao = document.getElementById('hongbao');
            const char = document.getElementById('char');
            const amountDisplay = document.getElementById('amountDisplay');
            const amount = document.getElementById('amount');
            const openBtn = document.getElementById('openBtn');
            const resultInfo = document.getElementById('resultInfo');
            const yourAmount = document.getElementById('yourAmount');
            const statusText = document.getElementById('statusText');
            const deviceIdElement = document.getElementById('deviceId');
            const receiveTime = document.getElementById('receiveTime');
            
            // æ˜¾ç¤ºçº¢åŒ…é‡‘é¢
            amount.textContent = packet.amount.toFixed(2);
            yourAmount.textContent = packet.amount.toFixed(2) + ' å…ƒ';
            
            // æ›´æ–°çŠ¶æ€
            if (packet.isNew) {
                statusText.textContent = 'å·²é¢†å–';
                statusText.style.color = '#e4393c';
                
                // æ›´æ–°çº¢åŒ…ä¸ºå·²æ‰“å¼€çŠ¶æ€
                hongbao.classList.add('opened');
                char.style.display = 'none';
                amountDisplay.classList.remove('hidden');
                
                // æ˜¾ç¤ºæ­å–œæ–‡å­—
                const congratsText = document.getElementById('congratsText');
                const messages = [
                    'æ­å–œå‘è´¢ï¼',
                    'å¥½è¿è¿è¿ï¼',
                    'è´¢æºå¹¿è¿›ï¼',
                    'çº¢åŒ…æ‹¿æ¥ï¼'
                ];
                congratsText.textContent = messages[Math.floor(Math.random() * messages.length)];
            } else {
                statusText.textContent = 'å·²é¢†å–ï¼ˆä¹‹å‰å·²æŠ¢ï¼‰';
                statusText.style.color = '#666';
                
                // å¦‚æœä¹‹å‰å·²ç»é¢†å–è¿‡ï¼Œä¹Ÿæ˜¾ç¤ºä¸ºå·²æ‰“å¼€çŠ¶æ€
                hongbao.classList.add('opened');
                char.style.display = 'none';
                amountDisplay.classList.remove('hidden');
            }
            
            // æ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯
            deviceIdElement.textContent = deviceId.substring(0, 10) + '...';
            receiveTime.textContent = new Date(packet.timestamp).toLocaleString();
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateStats();
            
            // æ˜¾ç¤ºç»“æœé¢æ¿
            resultInfo.style.display = 'block';
            
            // ç¦ç”¨æŒ‰é’®
            openBtn.disabled = true;
            openBtn.textContent = packet.isNew ? 'å·²é¢†å–' : 'å·²æŠ¢è¿‡';
            openBtn.style.background = '#ccc';
            openBtn.style.cursor = 'not-allowed';
            
            // æ˜¾ç¤ºåˆ†äº«æç¤º
            document.getElementById('shareTip').textContent = 
                `ğŸ’ æ‚¨æŠ¢åˆ°äº†${packet.amount.toFixed(2)}å…ƒï¼å¿«å»é¢†å–å§`;
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const stats = getRedPacketStats();
            
            document.getElementById('remainingCount').textContent = stats.remainingCount + ' ä¸ª';
            document.getElementById('remainingAmount').textContent = stats.remainingAmount + ' å…ƒ';
            
            // å¦‚æœæ‰€æœ‰çº¢åŒ…éƒ½å·²æŠ¢å®Œ
            if (stats.remainingCount === 0) {
                const shareTip = document.getElementById('shareTip');
                shareTip.innerHTML = 'ğŸ‰ æ‰€æœ‰çº¢åŒ…å·²è¢«æŠ¢å…‰ï¼<br>æ€»é‡‘é¢åˆ†é…ï¼š' + 
                    stats.totalAmounts.map(a => a.toFixed(2) + 'å…ƒ').join('ï¼Œ');
            }
        }
        
        // æ¸…é™¤æœ¬åœ°æ•°æ®ï¼ˆé‡æ–°å¼€å§‹ï¼‰
        function resetData() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®é‡æ–°å¼€å§‹å—ï¼Ÿ\nè¿™å°†é‡ç½®æ‰€æœ‰äººçš„çº¢åŒ…åˆ†é…è®°å½•ã€‚')) {
                localStorage.removeItem('redpacket_assigned_packets');
                localStorage.removeItem('redpacket_amounts');
                localStorage.removeItem('redpacket_device_id');
                
                // é‡æ–°åŠ è½½é¡µé¢
                location.reload();
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            const deviceId = generateDeviceId();
            const packet = getOrAssignRedPacket(deviceId);
            const stats = getRedPacketStats();
            
            // æ˜¾ç¤ºè®¾å¤‡IDï¼ˆéƒ¨åˆ†éšè—ï¼‰
            document.getElementById('deviceId').textContent = 
                deviceId.substring(0, 10) + '...';
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateStats();
            
            // å¦‚æœå·²ç»é¢†å–è¿‡çº¢åŒ…ï¼Œè‡ªåŠ¨æ˜¾ç¤ºç»“æœ
            if (packet && !packet.isNew) {
                setTimeout(() => {
                    openHongbao();
                }, 500);
            }
            
            // æ˜¾ç¤ºçº¢åŒ…é‡‘é¢åˆ†å¸ƒï¼ˆä»…ç”¨äºè°ƒè¯•ï¼Œå®é™…ä¸­å¯ä»¥ç§»é™¤ï¼‰
            console.log('çº¢åŒ…é‡‘é¢åˆ†å¸ƒï¼š', stats.totalAmounts.map(a => a.toFixed(2) + 'å…ƒ'));
        };
    </script>
</body>
</html>